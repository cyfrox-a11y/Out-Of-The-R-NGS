<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>OUT OF THE RINGS: ULTIMATE WORLD</title>
    <style>
        :root { --gold: #ffcc00; --emerald: #2ecc71; --ui-bg: rgba(10, 10, 15, 0.95); }
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; background: #050505; color: #fff; font-family: 'Segoe UI', sans-serif; user-select: none; }
        
        .screen { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; background: #000; }
        .btn { border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; text-transform: uppercase; padding: 15px 30px; letter-spacing: 1px; }
        .btn:active { transform: scale(0.9); }
        .btn-gold { background: var(--gold); color: #000; box-shadow: 0 0 15px rgba(255,204,0,0.3); }
        .btn-emr { background: var(--emerald); color: #fff; }

        #main-menu { display: none; background: radial-gradient(circle, #1a1c2c, #000); }
        .char-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 95%; max-width: 650px; margin: 25px 0; }
        .char-card { background: rgba(255,255,255,0.03); border: 1px solid #333; border-radius: 15px; padding: 15px; text-align: center; cursor: pointer; transition: 0.3s; }
        .char-card:hover { border-color: var(--gold); background: rgba(255,204,0,0.05); }
        .char-card i { font-style: normal; font-size: 2.5em; display: block; margin-bottom: 5px; }

        #game-ui { position: absolute; inset: 0; pointer-events: none; z-index: 10; display: none; }
        .stat-card { position: absolute; top: 20px; left: 20px; background: var(--ui-bg); border-left: 5px solid var(--gold); padding: 15px; border-radius: 0 15px 15px 0; min-width: 240px; pointer-events: auto; }
        .bar { width: 100%; height: 10px; background: #222; border-radius: 5px; margin: 6px 0; overflow: hidden; border: 1px solid #444; }
        .fill { height: 100%; transition: 0.4s cubic-bezier(0.17, 0.67, 0.83, 0.67); }

        #joystick-zone { position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px; pointer-events: auto; opacity: 0.8; }
        .actions { position: absolute; bottom: 50px; right: 50px; display: flex; gap: 20px; pointer-events: auto; }
        .act-btn { width: 80px; height: 80px; border-radius: 50%; background: rgba(0,0,0,0.5); border: 2px solid #fff; display: flex; align-items: center; justify-content: center; font-size: 32px; cursor: pointer; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #atk-btn { width: 100px; height: 100px; background: radial-gradient(circle, #ff4444, #660000); border: 3px solid #fff; }

        .floating-txt { position: absolute; font-weight: 900; pointer-events: none; animation: floatUp 1s forwards; text-shadow: 2px 2px 4px #000; font-size: 1.2em; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-100px); } }
    </style>
</head>
<body>

    <div id="login-screen" class="screen">
        <h1 style="color:var(--gold); font-size: 3em; margin: 0; text-shadow: 0 0 20px rgba(255,204,0,0.5);">OUT OF THE RINGS</h1>
        <p style="color: #888; margin-top: 5px;">LEGENDS REBORN</p>
        <input type="text" id="uname" placeholder="Kahraman ƒ∞smi..." maxlength="12" value="Sava≈ü√ßƒ±">
        <button class="btn btn-gold" onclick="showLobby()">D√úNYAYA Gƒ∞R</button>
    </div>

    <div id="main-menu" class="screen">
        <div style="display:flex; gap:20px; margin-bottom:20px;">
            <div class="btn" style="background:#111; border:1px solid #444;">üí∞ <span id="m-gold">0</span></div>
            <div class="btn" style="background:#111; border:1px solid #444;">üíé <span id="m-emr">0</span></div>
        </div>
        <div class="char-grid">
            <div class="char-card" onclick="play('knight')"><i>üõ°Ô∏è</i>≈û√∂valye</div>
            <div class="char-card" onclick="play('archer')"><i>üèπ</i>Ok√ßu</div>
            <div class="char-card" onclick="play('giant')"><i>üëπ</i>Dev</div>
            <div class="char-card" onclick="play('cavalry')"><i>üêé</i>S√ºvari</div>
            <div class="char-card" onclick="play('mage')"><i>üîÆ</i>B√ºy√ºc√º</div>
            <div class="char-card" id="king-card" style="border-color:var(--gold)" onclick="unlockKing()"><i>üëë</i>KRAL</div>
        </div>
        <button class="btn btn-emr" id="reward-btn" onclick="claimDaily()">üéÅ G√úNL√úK HEDƒ∞YE (500 Z√úMR√úT)</button>
    </div>

    <div id="game-ui">
        <div class="stat-card">
            <b id="h-name">OYUNCU</b> <span id="h-lvl-tag" style="color:var(--gold); margin-left:10px;">SEVƒ∞YE 1</span>
            <div class="bar"><div id="hp-bar" class="fill" style="background:linear-gradient(90deg, #ff4d4d, #990000); width:100%;"></div></div>
            <div class="bar" style="height:5px;"><div id="xp-bar" class="fill" style="background:#3498db; width:0%;"></div></div>
            <div style="font-size:0.85em; margin-top:8px; display:grid; grid-template-columns: 1fr 1fr; gap:8px; color:#ccc;">
                <span>üí∞ <span id="h-gold">0</span></span>
                <span>ü™µ <span id="h-wood">0</span></span>
                <span>üíé <span id="h-emr">0</span></span>
                <span>ü™® <span id="h-iron">0</span></span>
            </div>
        </div>
        <div id="joystick-zone"></div>
        <div class="actions">
            <div class="act-btn" onclick="openShop()">üõí</div>
            <div class="act-btn" id="atk-btn" onpointerdown="attack()">‚öîÔ∏è</div>
        </div>
    </div>

    <div id="float-layer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
    <script type="importmap">{"imports":{"three":"https://unpkg.com/three@0.150.1/build/three.module.js"}}</script>

    <script type="module">
        import * as THREE from 'three';

        const DATA = { gold: 0, emeralds: 0, wood: 0, iron: 0, hp: 100, maxHp: 100, xp: 0, lvl: 1, unlockedKing: false, role: 'knight' };
        const ROLES = {
            knight: { hp: 180, spd: 0.22, dmg: 35, col: 0xbdc3c7 },
            archer: { hp: 110, spd: 0.26, dmg: 25, col: 0x2ecc71 },
            giant:  { hp: 450, spd: 0.15, dmg: 55, col: 0x9b59b6, sc: 1.7 },
            cavalry:{ hp: 150, spd: 0.42, dmg: 35, col: 0xf39c12 },
            mage:   { hp: 100, spd: 0.24, dmg: 75, col: 0x3498db },
            king:   { hp: 600, spd: 0.32, dmg: 90, col: 0xf1c40f, sc: 1.4 }
        };

        let scene, camera, renderer, player, joystick, sword, composer;
        let entities = [], enemies = [], moveInput = {x:0, y:0}, isMoving = false;
        let clock = new THREE.Clock();

        window.showLobby = () => { 
            document.getElementById('login-screen').style.display='none'; 
            document.getElementById('main-menu').style.display='flex'; 
        };

        window.claimDaily = () => {
            DATA.emeralds = 500;
            document.getElementById('reward-btn').style.display = 'none';
            updateUI();
        };

        window.unlockKing = () => {
            if(DATA.unlockedKing) play('king');
            else if(DATA.emeralds >= 500) {
                DATA.emeralds -= 500; DATA.unlockedKing = true;
                play('king');
            } else alert("500 Z√ºmr√ºt Gerekiyor!");
        };

        window.play = (role) => {
            DATA.role = role; DATA.maxHp = ROLES[role].hp; DATA.hp = DATA.maxHp;
            document.getElementById('main-menu').style.display='none';
            document.getElementById('game-ui').style.display='block';
            document.getElementById('h-name').innerText = document.getElementById('uname').value.toUpperCase();
            initGame();
        };

        function initGame() {
            if(renderer) {
                renderer.dispose();
                document.body.removeChild(renderer.domElement);
                entities = []; enemies = [];
            }
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a140a);
            scene.fog = new THREE.FogExp2(0x0a140a, 0.04);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);

            const amb = new THREE.AmbientLight(0xffffff, 0.4);
            const sun = new THREE.DirectionalLight(0xffffff, 1.2);
            sun.position.set(30, 50, 20); sun.castShadow = true;
            sun.shadow.mapSize.width = 1024; sun.shadow.mapSize.height = 1024;
            scene.add(amb, sun);

            // Zemin Tasarƒ±mƒ±
            const floorGeo = new THREE.PlaneGeometry(200, 200);
            const floorMat = new THREE.MeshStandardMaterial({color: 0x1a2e1a, roughness: 0.8});
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI/2; floor.receiveShadow = true;
            scene.add(floor);

            createPlayer();
            buildWorld();

            if(joystick) joystick.destroy();
            joystick = nipplejs.create({ zone: document.getElementById('joystick-zone'), mode: 'static', position: {left: '70px', bottom: '70px'} });
            joystick.on('move', (e, d) => { moveInput = d.vector; isMoving = true; });
            joystick.on('end', () => { isMoving = false; });

            updateUI();
            animate();
        }

        function createPlayer() {
            const r = ROLES[DATA.role];
            player = new THREE.Group();
            
            // √úst D√ºzey Karakter Par√ßalarƒ±
            const cloth = new THREE.MeshStandardMaterial({color: r.col});
            const metal = new THREE.MeshStandardMaterial({color: 0x555555, metalness: 0.7});
            
            const torso = new THREE.Mesh(new THREE.BoxGeometry(0.7, 0.9, 0.4), cloth);
            torso.position.y = 1.15;
            
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.45, 0.45, 0.45), new THREE.MeshStandardMaterial({color: 0xffdbac}));
            head.position.y = 1.85;
            const helm = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.25, 0.5), metal);
            helm.position.y = 0.2; head.add(helm);

            // Bacaklar
            const legG = new THREE.BoxGeometry(0.25, 0.8, 0.25);
            const legL = new THREE.Mesh(legG, new THREE.MeshStandardMaterial({color: 0x111111}));
            legL.position.set(-0.2, 0.4, 0);
            const legR = legL.clone(); legR.position.x = 0.2;

            // Kollar
            const armG = new THREE.BoxGeometry(0.2, 0.8, 0.2);
            const armL = new THREE.Mesh(armG, cloth);
            armL.position.set(-0.45, 1.2, 0);
            const armR = armL.clone(); armR.position.x = 0.45;

            // KILI√á MODELƒ∞ (Efsanevi)
            sword = new THREE.Group();
            const blade = new THREE.Mesh(new THREE.BoxGeometry(0.12, 1.4, 0.03), new THREE.MeshStandardMaterial({color: 0xffffff, metalness: 0.9, emissive: 0x3498db, emissiveIntensity: 0.2}));
            blade.position.y = 0.8;
            const hilt = new THREE.Mesh(new THREE.CylinderGeometry(0.06, 0.06, 0.5), new THREE.MeshStandardMaterial({color: 0x3d2b1f}));
            const cross = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.08, 0.12), metal);
            sword.add(blade, hilt, cross);
            sword.position.y = -0.3; sword.rotation.x = Math.PI/2;
            armR.add(sword);

            player.add(torso, head, legL, legR, armL, armR);
            player.userData = { legL, legR, armL, armR };
            if(r.sc) player.scale.setScalar(r.sc);
            scene.add(player);
        }

        function buildWorld() {
            // Market Alanƒ± (0,0 yakƒ±nƒ±nda)
            const mPlatform = new THREE.Mesh(new THREE.CylinderGeometry(4, 4, 0.2, 32), new THREE.MeshStandardMaterial({color: 0x333333}));
            mPlatform.position.set(8, 0.05, 0); scene.add(mPlatform);
            
            const flag = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 6), new THREE.MeshStandardMaterial({color: 0x222222}));
            flag.position.set(8, 3, 0); scene.add(flag);
            const banner = new THREE.Mesh(new THREE.PlaneGeometry(2, 1.5), new THREE.MeshStandardMaterial({color: 0xff0000, side: THREE.DoubleSide}));
            banner.position.set(9, 5, 0); flag.add(banner);

            const npc = new THREE.Mesh(new THREE.CapsuleGeometry(0.5, 1, 4, 8), new THREE.MeshStandardMaterial({color: 0xffcc00}));
            npc.position.set(8, 1, 0); npc.userData = {type: 'market'};
            scene.add(npc); entities.push(npc);

            // Rastgele Detaylar (Aƒüa√ßlar, Kayalar, √áimenler)
            for(let i=0; i<250; i++) {
                const x = (Math.random()-0.5)*180, z = (Math.random()-0.5)*180;
                if(Math.sqrt(x*x + z*z) < 12) continue; // Merkeze koyma

                const r = Math.random();
                if(r > 0.6) spawnTree(x, z);
                else if(r > 0.4) spawnRock(x, z);
                else if(r > 0.2) spawnGrass(x, z);
                else if(r > 0.15) spawnEnemy(x, z);
            }
        }

        function spawnTree(x, z) {
            const group = new THREE.Group();
            const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.5, 4), new THREE.MeshStandardMaterial({color: 0x3d2b1f}));
            trunk.position.y = 2;
            const leaves = new THREE.Mesh(new THREE.ConeGeometry(2.5, 6, 8), new THREE.MeshStandardMaterial({color: 0x1a331a}));
            leaves.position.y = 5;
            group.add(trunk, leaves); group.position.set(x, 0, z);
            group.userData = { type: 'tree', hp: 100 };
            scene.add(group); entities.push(group);
        }

        function spawnRock(x, z) {
            const rock = new THREE.Mesh(new THREE.DodecahedronGeometry(Math.random()*1.5+0.5), new THREE.MeshStandardMaterial({color: 0x555555}));
            rock.position.set(x, 0.2, z); rock.rotation.set(Math.random(), Math.random(), Math.random());
            rock.scale.y = 0.6;
            rock.userData = { type: 'ore', hp: 150 };
            scene.add(rock); entities.push(rock);
        }

        function spawnGrass(x, z) {
            const grass = new THREE.Mesh(new THREE.PlaneGeometry(0.8, 0.8), new THREE.MeshBasicMaterial({color: 0x2ecc71, side: THREE.DoubleSide, transparent: true, opacity: 0.6}));
            grass.rotation.x = -Math.PI/2; grass.position.set(x, 0.02, z);
            scene.add(grass);
        }

        function spawnEnemy(x, z) {
            const en = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.2, 0.5), new THREE.MeshStandardMaterial({color: 0x220000}));
            body.position.y = 1;
            const eyes = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.1, 0.1), new THREE.MeshBasicMaterial({color: 0xff0000}));
            eyes.position.set(0, 1.8, 0.3);
            en.add(body, eyes); en.position.set(x, 0, z);
            en.userData = { type: 'enemy', hp: 140, speed: 0.05 + Math.random()*0.03 };
            scene.add(en); enemies.push(en);
        }

        window.attack = () => {
            sword.rotation.z = Math.PI/2;
            setTimeout(() => sword.rotation.z = 0, 150);

            const r = 5;
            enemies.forEach((en, i) => {
                if(player.position.distanceTo(en.position) < r) {
                    en.userData.hp -= ROLES[DATA.role].dmg;
                    floatText(en.position, "-"+ROLES[DATA.role].dmg, "#ff4444");
                    if(en.userData.hp <= 0) {
                        DATA.xp += 50; DATA.gold += 25; scene.remove(en); enemies.splice(i, 1);
                        updateUI(); checkLvl();
                    }
                }
            });

            entities.forEach((ent, i) => {
                if(player.position.distanceTo(ent.position) < r) {
                    if(ent.userData.type === 'market') openShop();
                    if(ent.userData.type === 'tree') {
                        ent.userData.hp -= 25; floatText(ent.position, "ODUN+", "brown");
                        if(ent.userData.hp <= 0) { DATA.wood += 15; scene.remove(ent); entities.splice(i, 1); }
                    }
                    if(ent.userData.type === 'ore') {
                        ent.userData.hp -= 25; floatText(ent.position, "DEMƒ∞R+", "gray");
                        if(ent.userData.hp <= 0) { DATA.iron += 8; scene.remove(ent); entities.splice(i, 1); }
                    }
                    updateUI();
                }
            });
        };

        window.openShop = () => {
            let gain = DATA.wood * 8 + DATA.iron * 25;
            if(gain > 0) {
                DATA.gold += gain; DATA.wood = 0; DATA.iron = 0;
                floatText(player.position, "+"+gain+" ALTIN", "gold"); updateUI();
            } else alert("Satacak kaynaƒüƒ±n yok! (Aƒüa√ß ve Kayalarƒ± kes)");
        };

        function checkLvl() {
            if(DATA.xp >= DATA.lvl*120) {
                DATA.lvl++; DATA.xp = 0; DATA.maxHp += 30; DATA.hp = DATA.maxHp;
                floatText(player.position, "SEVƒ∞YE ATLADIN!", "gold"); updateUI();
            }
        }

        function updateUI() {
            document.getElementById('h-gold').innerText = DATA.gold;
            document.getElementById('m-gold').innerText = DATA.gold;
            document.getElementById('h-emr').innerText = DATA.emeralds;
            document.getElementById('m-emr').innerText = DATA.emeralds;
            document.getElementById('h-wood').innerText = DATA.wood;
            document.getElementById('h-iron').innerText = DATA.iron;
            document.getElementById('h-lvl-tag').innerText = "SEVƒ∞YE " + DATA.lvl;
            document.getElementById('hp-bar').style.width = (DATA.hp/DATA.maxHp*100) + "%";
            document.getElementById('xp-bar').style.width = (DATA.xp/(DATA.lvl*120)*100) + "%";
        }

        function floatText(pos, txt, col) {
            const d = document.createElement('div');
            d.className = 'floating-txt'; d.innerText = txt; d.style.color = col;
            const v = pos.clone().project(camera);
            d.style.left = (v.x * .5 + .5) * window.innerWidth + 'px';
            d.style.top = (-(v.y * .5) + .5) * window.innerHeight + 'px';
            document.getElementById('float-layer').appendChild(d);
            setTimeout(()=>d.remove(), 1000);
        }

        function animate() {
            const req = requestAnimationFrame(animate);
            const t = clock.getElapsedTime();

            if(player) {
                if(isMoving) {
                    player.position.x += moveInput.x * ROLES[DATA.role].spd;
                    player.position.z -= moveInput.y * ROLES[DATA.role].spd;
                    player.rotation.y = Math.atan2(moveInput.x, moveInput.y);
                    
                    player.userData.legL.rotation.x = Math.sin(t*12)*0.6;
                    player.userData.legR.rotation.x = -Math.sin(t*12)*0.6;
                    player.userData.armL.rotation.x = -Math.sin(t*12)*0.4;
                }

                camera.position.lerp(new THREE.Vector3(player.position.x, 20, player.position.z + 20), 0.1);
                camera.lookAt(player.position);

                enemies.forEach(en => {
                    const d = en.position.distanceTo(player.position);
                    if(d < 16) {
                        const dir = new THREE.Vector3().subVectors(player.position, en.position).normalize();
                        en.position.x += dir.x * en.userData.speed;
                                               en.position.z += dir.z * en.userData.speed;
                        en.lookAt(player.position);
                        if(d < 2) {
                            DATA.hp -= 0.4; updateUI();
                            if(DATA.hp <= 0) {
                                cancelAnimationFrame(req);
                                alert("YENƒ∞LDƒ∞N! Karakter Se√ßimine D√∂n.");
                                document.getElementById('game-ui').style.display='none';
                                document.getElementById('main-menu').style.display='flex';
                            }
                        }
                    }
                });
            }
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>